# üîÑ Joint Revenue & Expense Forecasting Guide

## Overview

Joint forecasting ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ‡∏ã‡∏∂‡πà‡∏á‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠ **profit margin** ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô

### ‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô?

1. **Causal Relationship** - ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á ‚Üí ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ú‡∏±‡∏ô‡πÅ‡∏õ‡∏£‡∏™‡∏π‡∏á (COGS, Commission)
2. **Feedback Loop** - ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô Marketing ‚Üí ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° ‚Üí ‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° ‚Üí ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠
3. **Budget Constraints** - ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏ô % ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
4. **Profitability Analysis** - ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ Profit Margin ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤

---

## üéØ 4 ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå

### 1. Sequential (‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö) ‚≠ê **‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô**

**‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:**
```
Revenue ‚Üí Fixed Costs ‚Üí Variable Costs ‚Üí Semi-variable ‚Üí Total Expense ‚Üí Profit
```

**‡∏Ç‡πâ‡∏≠‡∏î‡∏µ:**
- ‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à
- ‚úÖ ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
- ‚úÖ ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏ô‡∏±‡∏Å

**‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢:**
- ‚ùå ‡πÑ‡∏°‡πà‡∏à‡∏±‡∏ö feedback loop
- ‚ùå ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î:**

```python
from src.engines.joint_engine import JointForecastEngine
import pandas as pd

# Load data
df_revenue = pd.read_csv('revenue.csv')
df_expense = pd.read_csv('expense.csv')

# Create engine
engine = JointForecastEngine()

# Forecast
result = engine.forecast_sequential(
    df_revenue=df_revenue,
    df_expense=df_expense,
    date_column='month',
    revenue_column='revenue',
    expense_column='expense',
    forecast_periods=12,
    revenue_model='prophet'  # or 'sarimax', 'xgboost'
)

# Results
print(result.profit_forecast)
print(f"Avg Margin: {result.metrics['avg_margin_pct']:.2f}%")
```

---

### 2. VAR (Simultaneous Forecasting) ‚≠ê‚≠ê **Advanced**

**‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£:**
- ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå revenue ‡πÅ‡∏•‡∏∞ expense **‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô**
- ‡πÉ‡∏ä‡πâ Vector Autoregression (VAR) model
- ‡∏à‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÅ‡∏ö‡∏ö bidirectional

**‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö:**
- ‡∏°‡∏µ feedback loop ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á revenue ‡πÅ‡∏•‡∏∞ expense
- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ô‡∏™‡∏π‡∏á
- ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Granger Causality

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î:**

```python
from src.engines.joint_engine import JointForecastEngine

engine = JointForecastEngine()

# VAR forecasting
result = engine.forecast_simultaneous_var(
    df=df,  # DataFrame with both revenue and expense
    date_column='month',
    revenue_column='revenue',
    expense_column='expense',
    forecast_periods=12,
    maxlags=12  # Auto-selected optimal lags
)

# Check causality
if result.component_results and 'causality' in result.component_results:
    print("\nGranger Causality Test:")
    print(result.component_results['causality'])

# Results
print(result.profit_forecast)
```

**Granger Causality Test:**
- ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ revenue ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠ expense ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
- p-value < 0.05 = ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•

---

### 3. Multi-output ML (XGBoost) ‚≠ê‚≠ê‚≠ê **High Accuracy**

**‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£:**
- ‡πÉ‡∏ä‡πâ Machine Learning ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå revenue ‡πÅ‡∏•‡∏∞ expense ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
- ‡∏™‡∏£‡πâ‡∏≤‡∏á features ‡∏à‡∏≤‡∏Å lags, rolling means, cross-variables
- Non-linear relationships

**‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö:**
- ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ accuracy ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
- ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (>24 periods)
- Pattern ‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô, non-linear

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î:**

```python
from src.engines.joint_engine import JointForecastEngine

engine = JointForecastEngine()

# Multi-output ML
result = engine.forecast_multioutput_ml(
    df=df,
    date_column='month',
    revenue_column='revenue',
    expense_column='expense',
    forecast_periods=12,

    # Optional: XGBoost parameters
    n_estimators=1000,
    learning_rate=0.01,
    max_depth=5
)

# Feature importance
if result.component_results:
    rev_importance = result.component_results['revenue_feature_importance']
    exp_importance = result.component_results['expense_feature_importance']

    print("\nTop features for Revenue:")
    print(sorted(rev_importance.items(), key=lambda x: x[1], reverse=True)[:5])

    print("\nTop features for Expense:")
    print(sorted(exp_importance.items(), key=lambda x: x[1], reverse=True)[:5])
```

---

### 4. Comparison (‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ)

```python
from src.engines.joint_engine import JointForecastEngine

engine = JointForecastEngine()

# Compare all methods
comparison = engine.compare_methods(
    df=df,
    date_column='month',
    revenue_column='revenue',
    expense_column='expense',
    forecast_periods=12
)

print(comparison)
```

**Output:**
```
           Method  Revenue MAPE  Expense MAPE  Avg Profit  Avg Margin %
      Sequential          5.2%          7.3%     350,000         30.5%
             VAR          5.8%          6.9%     345,000         29.8%
MultiOutput ML          4.1%          5.2%     360,000         31.2%
```

---

## üí∞ Profit & Margin Analysis

### Calculate KPIs

```python
from src.utils.profit_analysis import ProfitAnalyzer

analyzer = ProfitAnalyzer()

# Calculate KPIs
kpis = analyzer.calculate_kpis(
    revenue_df=result.revenue_forecast,
    expense_df=result.expense_forecast,
    revenue_col='revenue',
    expense_col='expense'
)

# Print report
report = analyzer.format_kpi_report(kpis)
print(report)
```

**Output:**
```
============================================================
PROFITABILITY ANALYSIS
============================================================

üìä Revenue & Expense
  Total Revenue:            12,500,000
  Total Expense:             8,750,000
  Total Profit:              3,750,000

üìà Averages
  Avg Revenue/period:        1,041,667
  Avg Expense/period:          729,167
  Avg Profit/period:           312,500

üí∞ Margins
  Avg Margin:                    30.00%
  Min Margin:                    28.50%
  Max Margin:                    31.80%

üìä Growth Rates
  Revenue Growth:                 8.50%
  Expense Growth:                 7.20%
  Profit Growth:                 12.30%

üìâ Ratios
  Expense/Revenue:               70.00%
============================================================
```

---

## üìä Scenario Analysis

### Create Scenarios

```python
from src.utils.profit_analysis import ProfitAnalyzer

analyzer = ProfitAnalyzer()

# Scenario analysis
scenarios = analyzer.scenario_analysis(
    revenue_forecast=result.revenue_forecast['revenue'].values,
    expense_forecast=result.expense_forecast['expense'].values,
    revenue_scenarios={
        'pessimistic': 0.90,  # -10%
        'base': 1.00,
        'optimistic': 1.10   # +10%
    },
    expense_scenarios={
        'pessimistic': 1.10,  # +10%
        'base': 1.00,
        'optimistic': 0.95   # -5%
    }
)

print(scenarios)
```

**Output:**
```
                        scenario  total_revenue  total_expense  total_profit  avg_margin_pct
pessimistic_revenue_pessimistic_expense     11,250,000      9,625,000     1,625,000           14.4%
          base_revenue_base_expense     12,500,000      8,750,000     3,750,000           30.0%
  optimistic_revenue_optimistic_expense     13,750,000      8,312,500     5,437,500           39.5%
```

---

## üé® Visualization

### Profit Margin Trend

```python
from src.utils.profit_analysis import ProfitAnalyzer

analyzer = ProfitAnalyzer()

# Plot margin trend
fig = analyzer.plot_margin_trend(
    dates=result.profit_forecast['ds'],
    revenue=result.profit_forecast['revenue'].values,
    expense=result.profit_forecast['expense'].values,
    title="12-Month Profit Margin Forecast"
)

fig.savefig('margin_trend.png')
```

### Profit Waterfall

```python
# Waterfall chart
fig = analyzer.plot_profit_waterfall(
    revenue=result.revenue_forecast['revenue'].sum(),
    fixed_expense=result.expense_forecast['fixed'].sum(),
    variable_expense=result.expense_forecast['variable'].sum(),
    other_expense=result.expense_forecast['semi_variable'].sum(),
    title="12-Month Profit Waterfall"
)

fig.savefig('profit_waterfall.png')
```

### Sensitivity Analysis

```python
# Sensitivity heatmap
sensitivity_df = analyzer.sensitivity_analysis(
    base_revenue=result.revenue_forecast['revenue'].mean(),
    base_expense=result.expense_forecast['expense'].mean(),
    revenue_range=(-20, 20),
    expense_range=(-20, 20),
    steps=10
)

fig = analyzer.plot_sensitivity_heatmap(sensitivity_df)
fig.savefig('sensitivity_heatmap.png')
```

---

## üîß Advanced Features

### Breakeven Analysis

```python
from src.utils.profit_analysis import ProfitAnalyzer

analyzer = ProfitAnalyzer()

# Calculate breakeven
breakeven = analyzer.breakeven_analysis(
    fixed_costs=300000,
    variable_cost_ratio=0.45,
    target_margin=30.0  # Target 30% margin
)

print(f"Breakeven Revenue: {breakeven['breakeven_revenue']:,.0f}")
print(f"Required for 30% margin: {breakeven['breakeven_revenue']:,.0f}")
```

---

## üìã Best Practices

### 1. Data Preparation

```python
from src.core.data_processor import DataProcessor

processor = DataProcessor()

# Validate data
validation = processor.validate_data(df, 'month', 'revenue')
print(validation)

# Clean data
df_clean = processor.clean_data(
    df,
    date_column='month',
    value_column='revenue',
    handle_missing='interpolate',
    handle_duplicates='last'
)
```

### 2. Model Selection

| Situation | Recommended Method |
|-----------|-------------------|
| First time forecasting | Sequential |
| Have correlation data | VAR |
| Need highest accuracy | Multi-output ML |
| Want to compare | All methods |

### 3. Validation

```python
# Cross-validation
from sklearn.model_selection import TimeSeriesSplit

tscv = TimeSeriesSplit(n_splits=3, test_size=12)

for train_idx, test_idx in tscv.split(df):
    df_train = df.iloc[train_idx]
    df_test = df.iloc[test_idx]

    # Train and evaluate
    result = engine.forecast_sequential(...)

    # Calculate metrics
    actual_profit = df_test['revenue'] - df_test['expense']
    forecast_profit = result.profit_forecast['profit']

    # Compare
    mape = np.mean(np.abs((actual_profit - forecast_profit) / actual_profit))
    print(f"MAPE: {mape:.2%}")
```

---

## üöÄ Quick Start Example

```python
from src.engines.joint_engine import JointForecastEngine
from src.utils.profit_analysis import ProfitAnalyzer
import pandas as pd

# Load data
df = pd.read_csv('data.csv')  # Must have: month, revenue, expense

# 1. Create engine
engine = JointForecastEngine()

# 2. Forecast (choose one method)
result = engine.forecast_sequential(
    df_revenue=df[['month', 'revenue']],
    df_expense=df[['month', 'expense']],
    forecast_periods=12
)

# 3. Analyze
analyzer = ProfitAnalyzer()
kpis = analyzer.calculate_kpis(
    result.revenue_forecast,
    result.expense_forecast
)

# 4. Print results
print(analyzer.format_kpi_report(kpis))
print("\nForecast:")
print(result.profit_forecast)

# 5. Visualize
fig = analyzer.plot_margin_trend(
    result.profit_forecast['ds'],
    result.profit_forecast['revenue'].values,
    result.profit_forecast['expense'].values
)
fig.savefig('forecast_result.png')
```

---

## üìñ Complete Example

See `examples/joint_forecast_example.py` for a comprehensive example that demonstrates all 4 approaches.

Run it:
```bash
cd forecast-system
python examples/joint_forecast_example.py
```

---

## ‚ùì FAQ

**Q: ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡πÑ‡∏´‡∏ô?**

A:
- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: Sequential
- ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏µ + ‡πÄ‡∏ß‡∏•‡∏≤: ‡∏•‡∏≠‡∏á VAR ‡πÅ‡∏•‡∏∞ Multi-output ML
- Production: Ensemble ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ

**Q: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏µ‡πà periods?**

A:
- Sequential: 24+ periods
- VAR: 36+ periods
- Multi-output ML: 36+ periods

**Q: ‡∏à‡∏∞‡∏£‡∏π‡πâ‡πÑ‡∏î‡πâ‡πÑ‡∏á‡∏ß‡πà‡∏≤ revenue ‡πÅ‡∏•‡∏∞ expense ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå?**

A:
```python
correlation = df['revenue'].corr(df['expense'])
print(f"Correlation: {correlation:.3f}")

# > 0.7 = High correlation ‚Üí Use VAR or Multi-output ML
# < 0.3 = Low correlation ‚Üí Sequential might be better
```

---

## üìö References

- [VAR Model Theory](https://en.wikipedia.org/wiki/Vector_autoregression)
- [Granger Causality](https://en.wikipedia.org/wiki/Granger_causality)
- [Multi-output ML](https://scikit-learn.org/stable/modules/multioutput.html)

---

**Created by Forecast System v1.0** | [GitHub](https://github.com/kaebmoo/nt)
