{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
    <h1>Admin Dashboard</h1>
    <p>เครื่องมือสำหรับผู้ดูแลระบบ</p>

    <div class="card my-4">
        <div class="card-header">สั่งรันโปรแกรม (ETL)</div>
<div class="card-body">
    <h5 class="card-title">Run ETL Jobs</h5>
    <p class="card-text">Select the year and month, then choose which ETL process to run.</p>
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Process 1: FI/Expense Report</h6>
                    <p class="card-text small">Generates the financial and expense summary from raw data. This should be run before the Main Revenue Report.</p>
                    <form method="POST" action="{{ url_for('admin.run_job') }}">
                        <input type="hidden" name="job_type" value="fi_expense">
                        <div class="form-group">
                            <label for="year-fi">Year</label>
                            <input type="number" class="form-control" id="year-fi" name="year" value="2025" required>
                        </div>
                        <div class="form-group">
                            <label for="month-fi">Month</label>
                            <input type="number" class="form-control" id="month-fi" name="month" value="10" required>
                        </div>
                        <button type="submit" class="btn btn-primary mt-2">Generate FI/Expense Report</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Process 2: Main Revenue Report</h6>
                    <p class="card-text small">Generates the main revenue report, including reconciliation against the FI/Expense data.</p>
                    <form method="POST" action="{{ url_for('admin.run_job') }}">
                        <input type="hidden" name="job_type" value="revenue_etl">
                        <div class="form-group">
                            <label for="year-etl">Year</label>
                            <input type="number" class="form-control" id="year-etl" name="year" value="2025" required>
                        </div>
                        <div class="form-group">
                            <label for="month-etl">Month</label>
                            <input type="number" class="form-control" id="month-etl" name="month" value="10" required>
                        </div>
                        <button type="submit" class="btn btn-secondary mt-2">Generate Main Revenue Report</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
    </div>

    <div class="card my-4">
        <div class="card-header">สถานะ Job</div>
        <div class="card-body">
            <h5>Jobs ที่กำลังรัน ({{ running_jobs|length }})</h5>
            <ul class="list-group">
                {% for job in running_jobs %}
                    <li class="list-group-item">{{ job.id }} - {{ job.description }}</li>
                {% else %}
                    <li class="list-group-item">ไม่มี Job ที่กำลังรัน</li>
                {% endfor %}
            </ul>
            <h5 class="mt-3">Jobs ที่ล้มเหลว ({{ failed_jobs|length }})</h5>
            <ul class="list-group">
                {% for job_id in failed_jobs %}
                     <li class="list-group-item text-danger">{{ job_id }}</li>
                {% else %}
                    <li class="list-group-item">ไม่มี Job ที่ล้มเหลว</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="card my-4">
        <div class="card-header">Log Files (5 ล่าสุด)</div>
        <div class="list-group list-group-flush">
            {% for log in log_files[:5] %}
                <a href="{{ url_for('admin.view_log', filename=log) }}" class="list-group-item list-group-item-action" target="_blank">
                    {{ log }}
                </a>
            {% else %}
                <li class="list-group-item">ไม่พบ Log files</li>
            {% endfor %}
            <a href="{{ url_for('admin.log_list') }}" class="list-group-item list-group-item-info text-center">ดู Log ทั้งหมด</a>
        </div>
    </div>
{% endblock %}
